{% extends "base.html" %}

{% block title %}Dashboard - MyCloud{% endblock %}

{% block content %}
<div class="flex-between mb-3">
    <h2>Dashboard</h2>
    <div class="storage-badge">
        Storage Used: {{ (usage_bytes|default(0) / 1024 / 1024)|round(2) }} MB
    </div>
</div>

<div class="card">
    <h3>Upload Files</h3>
    <div class="upload-zone" id="dropZone">
        <form id="uploadForm">
            <input type="file" name="file" id="fileInput" required style="display: none;" onchange="updateFileName()">
            <label for="fileInput" class="btn btn-primary mb-2">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Choose File
            </label>
            <div id="fileName" class="mb-2" style="color: var(--text-secondary);">No file selected</div>

            <div id="progressContainer" class="progress-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>

            <button type="submit" class="btn btn-primary mt-2" id="uploadBtn"
                style="width: 100%; max-width: 200px;">Start Upload</button>
        </form>
    </div>
    <div id="uploadStatus" class="mt-2 text-center" style="font-weight: 500;"></div>
</div>

<div class="card">
    <!-- Breadcrumbs & Navigation -->
    <div class="flex-between mb-3">
        <div class="breadcrumbs">
            <a href="/dashboard?path=/">Home</a>
            {% for crumb in breadcrumbs %}
            / <a href="/dashboard?path={{ crumb.path }}">{{ crumb.name }}</a>
            {% endfor %}
        </div>
        <form action="/create_folder" method="POST" style="display: flex; gap: 0.5rem;">
            <input type="hidden" name="path" value="{{ current_path }}">
            <input type="text" name="folder_name" placeholder="New Folder" required>
            <button type="submit" class="btn btn-primary" style="padding: 0.5rem 1rem;">+</button>
        </form>
    </div>

    {% if files %}
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th style="text-align: right;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for file in files %}
                <tr>
                    <td>
                        <div style="display: flex; align-items: center;">
                            <div class="file-icon" data-type="{{ file.type }}">
                                {% if file.type == 'folder' %}
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path
                                        d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z" />
                                </svg>
                                {% else %}
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                                    <polyline points="13 2 13 9 20 9"></polyline>
                                </svg>
                                {% endif %}
                            </div>
                            <div>
                                {% if file.type == 'folder' %}
                                <a href="/dashboard?path={{ file.path }}{{ file.name }}/"
                                    style="font-weight: 600; color: var(--text-main);">{{ file.name }}</a>
                                {% else %}
                                <div style="font-weight: 500; color: var(--text-main);">{{ file.name }}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">{{ (file.size / 1024 /
                                    1024)|round(2) }} MB</div>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td>
                        {% if file.type == 'folder' %}
                        <span style="color: var(--text-muted); font-size: 0.85rem;">Folder</span>
                        {% else %}
                        <span
                            style="color: var(--success); font-size: 0.85rem; display: flex; align-items: center; gap: 4px;">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="3">
                                <polyline points="20 6 9 17 4 12" />
                            </svg>
                            Synced
                        </span>
                        {% endif %}
                    </td>
                    <td style="text-align: right;">
                        {% if file.type != 'folder' %}
                        <a href="/download/{{ file.name }}" target="_blank" class="btn btn-primary"
                            style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">
                            Download
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; color: var(--text-muted); padding: 4rem; opacity: 0.6;">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"
            style="margin-bottom: 1rem; opacity: 0.5;">
            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
            <polyline points="13 2 13 9 20 9"></polyline>
        </svg>
        <p>No files in this folder.</p>
    </div>
    {% endif %}
</div>

<script>
    function updateFileName() {
        const input = document.getElementById('fileInput');
        document.getElementById('fileName').textContent = input.files.length > 0 ? input.files[0].name : 'No file selected';
    }

    const CHUNK_SIZE = 3 * 1024 * 1024; // 3MB (Optimized for Render Free Tier)

    document.getElementById('uploadForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        let fileInput = document.getElementById('fileInput');
        if (!fileInput.files.length) return;
        let file = fileInput.files[0];

        let statusDiv = document.getElementById('uploadStatus');
        let btn = document.getElementById('uploadBtn');
        let pBar = document.getElementById('progressBar');
        let pContainer = document.getElementById('progressContainer');

        statusDiv.style.color = 'var(--primary)';
        statusDiv.textContent = 'Preparing Upload...';
        btn.disabled = true;
        pContainer.style.display = 'block';
        pBar.style.width = '0%';

        let totalChunks = Math.ceil(file.size / CHUNK_SIZE);
        let chunkIds = [];
        let totalUploadedSize = 0;

        try {
            for (let i = 0; i < totalChunks; i++) {
                let start = i * CHUNK_SIZE;
                let end = Math.min(file.size, start + CHUNK_SIZE);
                let chunk = file.slice(start, end);

                statusDiv.textContent = `Uploading Chunk ${i + 1} of ${totalChunks}...`;

                let formData = new FormData();
                formData.append('file', chunk);
                formData.append('chunkIndex', i + 1);
                formData.append('filename', file.name);

                let response = await fetch('/upload_chunk', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    let errText = await response.text();
                    throw new Error(`Upload failed at chunk ${i + 1} (${response.status}): ${errText}`);
                }

                let result = await response.json();
                if (result.error) throw new Error(result.error);

                chunkIds.push(result.file_id);
                totalUploadedSize += result.size;

                // Update Progress
                let percent = Math.round(((i + 1) / totalChunks) * 100);
                pBar.style.width = percent + '%';
            }

            statusDiv.textContent = 'Finalizing...';

            // Finalize Upload
            // Get current path from URL or default to /
            const urlParams = new URLSearchParams(window.location.search);
            const currentPath = urlParams.get('path') || '/';

            let finalResponse = await fetch('/upload_complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    filename: file.name,
                    total_size: totalUploadedSize,
                    chunk_ids: chunkIds,
                    path: currentPath
                })
            });

            if (!finalResponse.ok) throw new Error('Finalization failed');

            statusDiv.style.color = 'var(--success)';
            statusDiv.textContent = '✅ Completed!';
            setTimeout(() => location.reload(), 1000);

        } catch (err) {
            console.error(err);
            statusDiv.style.color = 'var(--danger)';
            statusDiv.textContent = '❌ Error: ' + err.message;
            btn.disabled = false;
        }
    });
</script>
{% endblock %}